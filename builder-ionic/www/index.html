<!DOCTYPE html>
<html ng-app="buiiltApp">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title></title>

    <link rel="stylesheet" href="media/css/style.css">
    <link href="lib/ionic/css/ionic.css" rel="stylesheet">
    <!-- <link href="css/style.css" rel="stylesheet"> -->
    <!-- <link href="http://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="lib/jquery-ui/themes/base/jquery-ui.css">

    <!-- IF using Sass (run gulp sass first), then remove the CSS include above
    <link href="css/ionic.app.css" rel="stylesheet">
    -->
    

    <!-- ionic/angularjs js -->
    <script src="lib/jquery/dist/jquery.js"></script>
    <script src="lib/ionic/js/ionic.bundle.js"></script>

    <!-- cordova script (this will be a 404 during development) -->
    <script src="lib/ngCordova/dist/ng-cordova.js"></script>
    <script src="lib/ng-cordova-oauth/dist/ng-cordova-oauth.js"></script>

    <script src="cordova.js"></script>
    
    <script src="plugins/com.phonegap.plugins.PushPlugin/www/PushNotification.js"></script>
    <script>
        window.deviceToken = '';
        window.deviceplatform = '';
        
        var pushNotification;
        //IOS
        function onNotificationAPN(event) {
            //alert(event.payload.relatedto);
            var relatedto = event.relatedto;
            window.localStorage.setItem('push',event.push);
            window.localStorage.setItem('id',event.id);
            window.localStorage.setItem('projectid',event.projectid);
            if (relatedto == 'task'){
                window.localStorage.setItem('relatedto','task');
            }
            else if(relatedto == 'message')
                window.localStorage.setItem('relatedto','thread');
            else if (relatedto == 'people') {
                window.localStorage.setItem('relatedto','people');
            } else if (relatedto == 'board') {
                window.localStorage.setItem('relatedto','board');
            } else if (relatedto == "invite-people") {
                window.localStorage.setItem('relatedto','invite-people');
            }
            if (event.alert) {
                navigator.notification.alert(event.alert);
            }
            
            if (event.sound) {
                var snd = new Media(event.sound);
                snd.play();
            }
            
            if (event.badge) {
                pushNotification.setApplicationIconBadgeNumber(successHandler, errorHandler, event.badge);
            }
        };
        // Android and Amazon Fire OS
        function onNotification(e) {
          $("#app-status-ul").append('<li>EVENT -> RECEIVED:' + e.event + '</li>');

          switch (e.event) {
            case 'registered':
              if (e.regid.length > 0) {
                $("#app-status-ul").append('<li>REGISTERED -> REGID:' + e.regid + "</li>");
                // Your GCM push server needs to know the regID before it can push to this device
                // here is where you might want to send it the regID for later use.
                console.log("regID = " + e.regid);
                window.deviceToken = e.regid;
                $("#deviceToken").html(window.deviceToken);                
              }
              break;

            case 'message':
              // if this flag is set, this notification happened while we were in the foreground.
              // you might want to play a sound to get the user's attention, throw up a dialog, etc.
              if (e.foreground) {
                $("#app-status-ul").append('<li>--INLINE NOTIFICATION--' + e.payload.message + '</li>');

                // on Android soundname is outside the payload.
                // On Amazon FireOS all custom attributes are contained within payload
                //var soundfile = e.soundname || e.payload.sound;
                // if the notification contains a soundname, play it.
                //var my_media = new Media("/android_asset/www/"+ soundfile);
                if (e.payload.hasSound === "true") {
                  var my_media = new Media();
                  my_media.play();
                }
              } else {  // otherwise we were launched because the user touched a notification in the notification tray.
                if (e.coldstart) {
                  $("#app-status-ul").append('<li>--COLDSTART NOTIFICATION--' + '</li>');
                } else {
                  $("#app-status-ul").append('<li>--BACKGROUND NOTIFICATION--' + '</li>');
                }
              }

                try {
                    var path = e.payload.path;
                    if (path) {
                        window.location = path;
                    }
                } catch (error) {
                    console.log("Parsing push notification: " + JSON.stringify(e));
                }

              $("#app-status-ul").append('<li>MESSAGE -> MSG: ' + e.payload.message + '</li>');
              //Only works for GCM
              //$("#app-status-ul").append('<li>MESSAGE -> MSGCNT: ' + e.payload.msgcnt + '</li>');
              //Only works on Amazon Fire OS
              $status.append('<li>MESSAGE -> TIME: ' + e.payload.timeStamp + '</li>');
              break;

            case 'error':
              $("#app-status-ul").append('<li>ERROR -> MSG:' + e.msg + '</li>');
              break;

            default:
              $("#app-status-ul").append('<li>EVENT -> Unknown, an event was received and we do not know what it is</li>');
              break;
          }
        };

    function errorHandler(error) {
        console.log('error = ' + error);
        alert('error = ' + error);
    };

    function successHandler(result) {
        console.log('result = ' + result);
    };
    
    function tokenHandler(result) {
        // Your iOS push server needs to know the token before it can push to this device
        // here is where you might want to send it the token for later use.
        console.log('device token = ' + result);
        window.deviceToken = result;
        //alert(result);
    };
    
    document.addEventListener("deviceready", function () {
        pushNotification = window.plugins.pushNotification;
      
        window.deviceplatform = device.platform.toLowerCase();
        // alert(window.deviceplatform);
        if (window.deviceplatform === 'ios' ) {
        //ios
            console.log('<li>registering ' + device.platform + '</li>');
            pushNotification.register(
                tokenHandler,
                errorHandler,
                {
                "badge": "true",
                "sound": "true",
                "alert": "true",
                "ecb": "onNotificationAPN"
            });
          	document.addEventListener("resume", onResume, false);
            function onResume(){
                var push = 0;
                push = window.localStorage.getItem('push');
                var related = window.localStorage.getItem('relatedto');
                var id = window.localStorage.getItem('id');
                var projectid = window.localStorage.getItem('projectid');
                if (push == 1){
                    if (related == 'task'){
                        window.location.href = "#/task/"+id;
                    } else if (related == "board") {
                        window.location.href="#/board/"+id;
                    } else if (related == "people") {
                        window.location.href="#/"+projectid+"/people-chat/"+id;
                    } else if (related == "invite-people") {
                        window.location.href = "#/dashboard";
                    }
                    else if (related == 'thread') {
                        window.location.href = "#/"+projectid+"/thread/"+id;
                    }
                    push = 0;
                    window.localStorage.removeItem('relatedto');
                    window.localStorage.removeItem('push');
                    window.localStorage.removeItem('id');
                    window.localStorage.removeItem('projectid');
                }
          
            };
        }
        //android
        else if ( device.platform == 'android' || device.platform == 'Android' || device.platform == "amazon-fireos" ){
                pushNotification.register(
                successHandler,
                errorHandler,
                {
                    "senderID":"94493523535",
                    "ecb":"onNotification"
                });
            }
        });
                                                            
        </script>
    <!-- your app's js -->
    <script src="js/app.js"></script>
    

    
</head>

<body animation="slide-left-right-ios7">
    <div>
        <div>
            <ion-nav-bar align-title="center" class="bar-calm">
                <ion-nav-back-button ng-hide="currentState.name == 'dashboard'" side="left" class="button-icon icon ion-ios-arrow-left"> Back</ion-nav-back-button>
            </ion-nav-bar>
            <ion-nav-view></ion-nav-view>
        </div>
    </div>
  
    <script src="lib/jquery-ui/ui/jquery-ui.js"></script>
    <script src="lib/lodash/dist/lodash.js"></script>
    <script src="lib/moment/min/moment.min.js"></script>
    <script src="lib/angular-sanitize/angular-sanitize.js"></script>
    <script src="lib/angular-animate/angular-animate.js"></script>
    <script src="lib/angular-resource/angular-resource.js"></script>
    <script src="lib/angular-ui-utils/ui-utils.js"></script>
    <script src="lib/angular-socket-io/socket.min.js"></script>
    <script src="lib/angular-notify/angular-notify.js"></script>
    <script src="lib/angular-loading-bar/build/loading-bar.js"></script>
    <script src="lib/velocity/velocity.js"></script>
    <script src="lib/moment/min/moment-with-langs.js"></script>
    <script src="lib/restangular/src/restangular.js"></script>
    <script src="lib/filepicker-js/filepicker.js"></script>
    <script src="lib/angular-filepicker/dist/angular_filepicker.js"></script>
    <script src="lib/angular-file-upload/angular-file-upload.js"></script>

    <script src="js/components/filters.js"></script>
    <script src="js/components/directive.js"></script>
    <script src="js/components/socket/socket.service.js"></script>
    <script src="js/components/modal/modal.service.js"></script>

    <script src="http://localhost:9000/socket.io-client/socket.io.js"></script>
    <!-- // <script src="http://buiilt.com.au/socket.io-client/socket.io.js"></script> -->

    <script src="js/directives/task/task-directive.js"></script>
    <script src="js/directives/message/message-directive.js"></script>
    <script src="js/directives/notification/notification-directive.js"></script>
    <script src="js/directives/document/document-directive.js"></script>

    <script src="js/services/auth-service.js"></script>
    <script src="js/services/user-service.js"></script>
    <script src="js/services/contractors-services.js"></script>
    <script src="js/services/material-package-service.js"></script>
    <script src="js/services/project-service.js"></script>
    <script src="js/services/quote-service.js"></script>
    <script src="js/services/document-service.js"></script>
    <script src="js/services/upload-service.js"></script>
    <script src="js/services/team-service.js"></script>
    <script src="js/services/inviteToken-service.js"></script>
    <script src="js/services/package-invite-service.js"></script>
    <script src="js/services/package-service.js"></script>
    <script src="js/services/staff-package.js"></script>
    <script src="js/services/task-service.js"></script>
    <script src="js/services/file-service.js"></script>
    <script src="js/services/builder-package.js"></script>
    <script src="js/services/quote-request-service.js"></script>
    <script src="js/services/registry-for-contractor-service.js"></script>
    <script src="js/services/contractor-request-service.js"></script>
    <script src="js/services/material-request-service.js"></script>
    <script src="js/services/validate-invite-service.js"></script>
    <script src="js/services/notification-service.js"></script>
    <script src="js/services/message-service.js"></script>
    <script src="js/services/add-on-package-service.js"></script>
    <script src="js/services/variation-request-service.js"></script>
    <script src="js/services/device-service.js"></script>
    <script src="js/services/design-service.js"></script>
    <script src="js/services/board-service.js"></script>
    <script src="js/services/people-service.js"></script>
    <script src="js/services/people-chat-service.js"></script>

    <script src="js/modules/auth/main.js"></script>
    <script src="js/modules/auth/signin/signin-controller.js"></script>
    <script src="js/modules/auth/signout/signout-controller.js"></script>

    <script src="js/modules/dashboard/main.js"></script>
    <script src="js/modules/dashboard/dashboard-controller.js"></script>

    <script src="js/modules/project/main.js"></script>
    <script src="js/modules/project/view-project/view-project-controller.js"></script>

    <script src="js/modules/staff/main.js"></script>
    <script src="js/modules/staff/staff-controller.js"></script>

    <script src="js/modules/thread/main.js"></script>
    <script src="js/modules/thread/thread-detail-controller.js"></script>
    <script src="js/modules/task/main.js"></script>
    <script src="js/modules/task/task-detail-controller.js"></script>
    <script src="js/modules/file/main.js"></script>
    <script src="js/modules/file/file-detail-controller.js"></script>

    <script src="js/modules/notification/main.js"></script>
    <script src="js/modules/notification/view-notification/view-notification-controller.js"></script>
    <script src="js/modules/board/main.js"></script>
    <script src="js/modules/board/board-controller.js"></script>
    <script src="js/modules/people/main.js"></script>
    <script src="js/modules/people/people-controller.js"></script>
    <script src="js/modules/people-chat/main.js"></script>
    <script src="js/modules/people-chat/people-chat-controller.js"></script>

    <script src="assets/js/jquery.slimscroll.js"></script> 
  </body>
</html>
