<!DOCTYPE html>
<html ng-app="buiiltApp">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src data: gap: https://ssl.gstatic.com 'self' https://*"; style-src 'self' 'unsafe-inline'> -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com https://buiilt.com.au https://api.mixpanel.com; style-src 'self' 'unsafe-inline'; media-src *"> -->
    <title></title>

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="lib/jquery-ui/themes/base/jquery-ui.css">

    <!-- IF using Sass (run gulp sass first), then remove the CSS include above -->
    <link href="css/ionic.app.css" rel="stylesheet">
   
    

    <!-- ionic/angularjs js -->
    <script src="lib/jquery/dist/jquery.js"></script>
    <script src="lib/ionic/js/ionic.bundle.js"></script>

    <!-- cordova script (this will be a 404 during development) -->
    <script src="lib/ngCordova/dist/ng-cordova.js"></script>
    <script src="lib/ng-cordova-oauth/dist/ng-cordova-oauth.js"></script>

    <script src="cordova.js"></script>
    
    <script src="plugins/com.phonegap.plugins.PushPlugin/www/PushNotification.js"></script>
    <script>
        window.deviceToken = '';
        window.deviceplatform = '';
        
        var pushNotification, relatedto, itemId, projectId;
        //IOS
        function onNotificationAPN(event) {
            relatedto = event.relatedto;
            itemId = event.id;
            projectId = event.projectid;
            if (event.alert) {
                navigator.notification.alert(event.alert);
            }
            
            if (event.sound) {
                var snd = new Media(event.sound);
                snd.play();
            }
            
            if (event.badge) {
                pushNotification.setApplicationIconBadgeNumber(successHandler, errorHandler, event.badge);
            }
        };
        // Android and Amazon Fire OS
        function onNotification(e) {
          $("#app-status-ul").append('<li>EVENT -> RECEIVED:' + e.event + '</li>');

          switch (e.event) {
            case 'registered':
              if (e.regid.length > 0) {
                $("#app-status-ul").append('<li>REGISTERED -> REGID:' + e.regid + "</li>");
                // Your GCM push server needs to know the regID before it can push to this device
                // here is where you might want to send it the regID for later use.
                console.log("regID = " + e.regid);
                window.deviceToken = e.regid;
                $("#deviceToken").html(window.deviceToken);                
              }
              break;

            case 'message':
              // if this flag is set, this notification happened while we were in the foreground.
              // you might want to play a sound to get the user's attention, throw up a dialog, etc.
              if (e.foreground) {
                $("#app-status-ul").append('<li>--INLINE NOTIFICATION--' + e.payload.message + '</li>');

                // on Android soundname is outside the payload.
                // On Amazon FireOS all custom attributes are contained within payload
                //var soundfile = e.soundname || e.payload.sound;
                // if the notification contains a soundname, play it.
                //var my_media = new Media("/android_asset/www/"+ soundfile);
                if (e.payload.hasSound === "true") {
                  var my_media = new Media();
                  my_media.play();
                }
              } else {  // otherwise we were launched because the user touched a notification in the notification tray.
                if (e.coldstart) {
                  $("#app-status-ul").append('<li>--COLDSTART NOTIFICATION--' + '</li>');
                } else {
                  $("#app-status-ul").append('<li>--BACKGROUND NOTIFICATION--' + '</li>');
                }
              }

                try {
                    var path = e.payload.path;
                    if (path) {
                        window.location = path;
                    }
                } catch (error) {
                    console.log("Parsing push notification: " + JSON.stringify(e));
                }

              $("#app-status-ul").append('<li>MESSAGE -> MSG: ' + e.payload.message + '</li>');
              //Only works for GCM
              //$("#app-status-ul").append('<li>MESSAGE -> MSGCNT: ' + e.payload.msgcnt + '</li>');
              //Only works on Amazon Fire OS
              $status.append('<li>MESSAGE -> TIME: ' + e.payload.timeStamp + '</li>');
              break;

            case 'error':
              $("#app-status-ul").append('<li>ERROR -> MSG:' + e.msg + '</li>');
              break;

            default:
              $("#app-status-ul").append('<li>EVENT -> Unknown, an event was received and we do not know what it is</li>');
              break;
          }
        };

    function errorHandler(error) {
        console.log('error = ' + error);
        alert('error = ' + error);
    };

    function successHandler(result) {
        console.log('result = ' + result);
    };
    
    function tokenHandler(result) {
        // Your iOS push server needs to know the token before it can push to this device
        // here is where you might want to send it the token for later use.
        console.log('device token = ' + result);
        window.deviceToken = result;
    };
    
    document.addEventListener("deviceready", function () {
        pushNotification = window.plugins.pushNotification;
      
        window.deviceplatform = device.platform.toLowerCase();
        if (window.deviceplatform === 'ios' ) {
        //ios
            console.log('<li>registering ' + device.platform + '</li>');
            pushNotification.register(
                tokenHandler,
                errorHandler,
                {
                "badge": "true",
                "sound": "true",
                "alert": "true",
                "ecb": "onNotificationAPN"
            });
          	document.addEventListener("resume", onResume, false);
            function onResume(){
                setTimeout(function() {
                    if (relatedto === "thread") {
                        window.location.href = "#/"+itemId+"/thread";
                    } else if (relatedto === "task") {
                        window.location.href = "#/"+itemId+"/task";
                    } else if (relatedto === "project") {
                        window.location.href = "#/dashboard";
                        window.localStorage.setItem("pushProject", projectId);
                    } else if (relatedto==="document") {
                        window.location.href="#/"+itemId+"/document";
                    } else if (relatedto==="file") {
                        window.location.href="#/"+itemId+"/file";
                    }
                    relatedto = null;
                }, 1000);
            };
        }
        //android
        else if ( device.platform == 'android' || device.platform == 'Android' || device.platform == "amazon-fireos" ){
                pushNotification.register(
                successHandler,
                errorHandler,
                {
                    "senderID":"94493523535",
                    "ecb":"onNotification"
                });
            }
        });
                                                            
        </script>
    <!-- your app's js -->
    <script src="js/app.js"></script>
</head>

<body animation="slide-left-right-ios7">
    <div>
        <div>
            <ion-nav-bar align-title="center" class="bar-calm">
                <ion-nav-back-button ng-hide="currentState.name == &apos;dashboard&apos; || currentState.name == &apos;signin&apos;" side="left" class="button-icon icon ion-ios-arrow-left"> Back</ion-nav-back-button>
            </ion-nav-bar>
            <ion-nav-view></ion-nav-view>
        </div>
    </div>
  
    <script src="lib/jquery-ui/ui/jquery-ui.js"></script>
    <script src="lib/lodash/dist/lodash.js"></script>
    <script src="lib/moment/min/moment.min.js"></script>
    <script src="lib/angular-sanitize/angular-sanitize.js"></script>
    <script src="lib/angular-animate/angular-animate.js"></script>
    <script src="lib/angular-resource/angular-resource.js"></script>
    <script src="lib/angular-ui-utils/ui-utils.js"></script>
    <script src="lib/angular-socket-io/socket.min.js"></script>
    <script src="lib/angular-notify/angular-notify.js"></script>
    <script src="lib/angular-loading-bar/build/loading-bar.js"></script>
    <script src="lib/velocity/velocity.js"></script>
    <script src="lib/moment/min/moment-with-langs.js"></script>
    <script src="lib/restangular/src/restangular.js"></script>

    <script src="lib/filepicker-js/filepicker.min.js" type="text/javascript"></script>
    <script src="lib/angular-filepicker/dist/angular_filepicker.js"></script>

    <script src="js/components/filters.js"></script>
    <script src="js/components/directive.js"></script>
    <script src="js/components/socket/socket.service.js"></script>

    <script src="http://localhost:9000/socket.io-client/socket.io.js"></script>
    <!-- // <script src="https://buiilt.com.au/socket.io-client/socket.io.js"></script> -->

    <script src="js/services/auth-service.js"></script>
    <script src="js/services/user-service.js"></script>
    <script src="js/services/project-service.js"></script>
    <script src="js/services/team-service.js"></script>
    <script src="js/services/task-service.js"></script>
    <script src="js/services/file-service.js"></script>
    <script src="js/services/notification-service.js"></script>
    <script src="js/services/message-service.js"></script>
    <script src="js/services/people-service.js"></script>
    <script src="js/services/device-service.js"></script>
    <script src="js/services/document-service.js"></script>
    <script src="js/services/upload-service.js"></script>
    <script src="js/services/activity-service.js"></script>
    <script src="js/services/token-service.js"></script>

    <script src="js/modules/auth/main.js"></script>
    <script src="js/modules/auth/signin/signin-controller.js"></script>
    <script src="js/modules/auth/signout/signout-controller.js"></script>

    <script src="js/modules/dashboard/main.js"></script>
    <script src="js/modules/dashboard/dashboard-controller.js"></script>

    <script src="js/modules/thread/main.js"></script>
    <script src="js/modules/thread/thread-detail-controller.js"></script>

    <script src="js/modules/task/main.js"></script>
    <script src="js/modules/task/task-detail-controller.js"></script>

    <script src="js/modules/file/main.js"></script>
    <script src="js/modules/file/file-detail-controller.js"></script>

    <script src="js/modules/document/main.js"></script>
    <script src="js/modules/document/detail/document-detail-controller.js"></script>
    <script src="js/modules/document/set/document-set-controller.js"></script>

    <!-- start Mixpanel -->
<script type="text/javascript">(function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="js/mixpanel.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);
mixpanel.init("632ac8a0857fe8e177fed40431d8acfb");</script>
<!-- end Mixpanel -->
    <!-- this key is production e6d853e9a8af11b4aa36ea63291ead38
    this key is development 632ac8a0857fe8e177fed40431d8acfb -->

  </body>
</html>
